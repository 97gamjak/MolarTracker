name: BUILD LINUX

on:
  pull_request:
    branches: ["*"]
  push:
    branches: ["dev"]
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      QT_VERSION: "6.8.3"
      BUILD_TYPE: "Release"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # -------------------------
      # Compute artifact/version names (only on dev branch or tags)
      # -------------------------
      - name: Compute names
        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/dev'
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF_NAME}"
            IS_TAG="ON"
          else
            IS_TAG="OFF"
            if git describe --tags --abbrev=0 >/dev/null 2>&1; then
              LATEST_TAG="$(git describe --tags --abbrev=0)"
            else
              LATEST_TAG="0.0.0"
            fi
            VERSION="${LATEST_TAG}-dev"
          fi

          echo "ARTIFACT_VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "IS_TAG=${IS_TAG}" >> "$GITHUB_ENV"

          echo "LINUX_NAME=MolarTracker-linux-${VERSION}" >> "$GITHUB_ENV"

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "LINUX_LATEST=MolarTracker-linux-latest" >> "$GITHUB_ENV"
          fi

      # -------------------------
      # Build tools
      # -------------------------
      - name: Install build tools (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y     \
              ninja-build             \
              pkg-config              \
              libcurl4-openssl-dev    \
              cppcheck                \
              clang-tidy

      # -------------------------
      # Install Qt
      # -------------------------
      - name: Install Qt (Ubuntu)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          target: desktop

      # -------------------------
      # Configure + build
      # -------------------------
      - name: Configure (Ubuntu)
        shell: bash
        run: |
          set -euo pipefail
          IS_TAG_FLAG=OFF
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then IS_TAG_FLAG=ON; fi

          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DMOLARTRACKER_IS_TAG="${IS_TAG_FLAG}" \
            -DMOLARTRACKER_GIT_TAG="${GITHUB_REF_NAME}"

      - name: Build (Ubuntu)
        run: |
          cmake --build build --verbose

      # -------------------------
      # Run tests (on the built binaries)
      # -------------------------
      - name: Run tests (Ubuntu)
        run: |
          ctest --test-dir build --output-on-failure

      # -------------------------
      # Run cppcheck (on the compile_commands.json from the build, so it has all the correct include paths)
      # -------------------------
      - name: Run cppcheck
        run: |
          cppcheck \
              --project=build/compile_commands.json \
              --quiet \
              --file-filter=src/* \
              --suppress=useStlAlgorithm \
              --enable=all \
              --enable=performance \
              --enable=style \
              --enable=information \
              --enable=portability \
              --error-exitcode=1 \
              --suppressions-list=.cppcheck \
              --suppress=missingIncludeSystem \
              --inline-suppr \
              --inconclusive \
              --library=qt \
              -I src

      # -------------------------
      # Run clang-tidy (also using the compile_commands.json from the build)
      # -------------------------
      # - name: Run clang-tidy
      #   run: |
      #     clang-tidy \
      #         --warnings-as-errors=* \
      #         --compile-commands=build/compile_commands.json \
      #         $(find src -name '*.cpp')
      #TODO: in order to activate this we definitely need to clean up code base before

      # -------------------------
      # Package for Release assets (ONLY on tags)
      # -------------------------
      - name: Package (Linux, tag)
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          set -euo pipefail
          test -f build/bin/MolarTracker || test -f build/bin/MolarTracker.exe || true
          tar -C build/bin -czf "MolarTracker-linux-${GITHUB_REF_NAME}.tar.gz" MolarTracker
          cp build/compile_commands.json "compile_commands-${GITHUB_REF_NAME}.json"

      # -------------------------
      # Upload to GitHub Release (ONLY on tags)
      # Requires the Release to already exist for that tag (your other workflow creates it)
      # -------------------------
      - name: Upload release assets (Linux)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            MolarTracker-linux-${{ github.ref_name }}.tar.gz
            compile_commands-${{ github.ref_name }}.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------
      # Upload Actions artifacts (ONLY on tags/dev; convenient for quick download)
      # -------------------------
      - name: Upload Linux artifact (Actions, versioned)
        if: (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/dev')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.LINUX_NAME }}
          path: |
            build/bin/MolarTracker*
            build/compile_commands.json
          if-no-files-found: error

      # -------------------------
      # Tag pushes: also upload "latest" Actions artifacts
      # -------------------------
      - name: Upload Linux artifact (Actions, latest)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.LINUX_LATEST }}
          path: |
            build/bin/MolarTracker*
            build/compile_commands.json
          if-no-files-found: error
